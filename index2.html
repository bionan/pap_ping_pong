<!DOCTYPE html>
<html lang="pt">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">

   
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@900&family=Tourney:wght@700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: grey;
        }

        #jogo {
            background-color: black;
            border: 5px solid white;
        }

        * {
            margin:0;
            padding:0;
        }

        #contentor {
            display: grid;
            width: 100%;
            place-items: center;
            min-height: 500px;
            min-width: 670px;
            height: 95vh;
        }

        button {
            padding: 5px;
        }
    </style>

</head>

<body>

    <div id="contentor">
        <section>
            <canvas id="jogo" width="640" height="480"></canvas>
            <div class="botoes">
                <button>Novo Jogo</button> <button id="btnSom">Som OFF</button>
            </div>
        </section>
    </div>


    <script>

        var timer; // id do temporizador da loop do jogo
        var contador = 3; // contador da contagem regressiva
        var em_contagem = false;

        // Indicador de som ON/OFF. Inicialmente ON
        var som = true;
        var btnSom = document.getElementById("btnSom");
        btnSom.addEventListener("click", som_onoff);
        
        function som_onoff(e) {
            som = !som;
            if (som) {
                btnSom.innerText = "Som OFF";
            } else {
                btnSom.innerText = "Som ON";
            }
        }


        // Dimensões e velocidade das raquetes
        var ALT_RAQ = 100;
        var LARG_RAQ = 10;
        var VEL_RAQ = 10;

        // Dimensões do canvas
        ALT_CANVAS = 480;
        LARG_CANVAS = 640;

        // Velocidade da bola
        VEL_BOLA = 8;

        var canvas = document.getElementById("jogo");
        var ctx = canvas.getContext("2d");

        ctx.width = LARG_CANVAS;
        ctx.height = ALT_CANVAS;

        // No arranque da partida as raquetes deverão estar
        // centradas verticalmente

        var raquete1 = { x: 50, y: (ALT_CANVAS - ALT_RAQ)/2 , alt: ALT_RAQ, larg: LARG_RAQ, vel: VEL_RAQ, pontos: 0 };
        var raquete2 = { x: canvas.width - 50, y: (ALT_CANVAS - ALT_RAQ)/2, alt: ALT_RAQ, larg: LARG_RAQ, vel: VEL_RAQ, pontos: 0 };

        // gerar um ângulo ao acaso entre 0 rad e 2pi rad
        var ang = anguloAoAcaso();
        var vx = velBolaX(ang);
        var vy = velBolaY(ang);

        console.log(vx);
        console.log(vy);

        var bola = { x: canvas.width / 2, y: canvas.height / 2, alt: 10, larg: 10, velx: vx, vely: vy };

        var r1tecla = { cima: false, baixo: false };

        var r2tecla = { cima: false, baixo: false };

        document.addEventListener('keydown', teclaPressionada);
        document.addEventListener('keyup', teclaLiberada);

        var somBola = new Audio('bola1.mp3');
        var somLateral = new Audio('bola2.mp3');

        timer = setInterval(jogo, 20);

        function jogo() {

            moveRaquetes();
            moveBola();
            testaColisao();
            atualizaPontos();
            if ( em_contagem ) {
                return;
            }
            desenha();

        }


        function moveRaquetes() {

            if (r1tecla.cima == true) {
                raquete1.y = raquete1.y - raquete1.vel;

                // raquete ultrapassou o limite superior? (y < 0)
                if (raquete1.y < 0) {
                    raquete1.y = 0;
                }

            } else if (r1tecla.baixo == true) {
                raquete1.y = raquete1.y + raquete1.vel;

                // raquete ultrapassou o limite inferior?
                if (raquete1.y + raquete1.alt > canvas.height) {
                    raquete1.y = raquete1.y - raquete1.vel;
                }
            }

            // VERIFICAR SE RAQUETE2 PRECISA SER MOVIDA
            //
            if (r2tecla.cima == true) {

                raquete2.y = raquete2.y - raquete2.vel;

                if (raquete2.y < 0) {
                    raquete2.y = 0;
                }

            } else if (r2tecla.baixo == true) {

                raquete2.y = raquete2.y + raquete2.vel;

                if (raquete2.y + raquete2.alt > canvas.height) {
                    raquete2.y = raquete2.y - raquete2.vel;
                }
            }

        }

        function moveBola() {

            bola.x = bola.x + bola.velx;
            bola.y = bola.y + bola.vely;


            if (bola.y + bola.alt >= canvas.height || bola.y <= 0) {
                bola.vely = -bola.vely;

                if (som) {
                    somLateral.play();
                }
            }

        }

        function testaColisao() {

            if (existeColisao(raquete1, bola) || existeColisao(raquete2, bola)) {
                // alterar a direção da bola
                bola.velx = -bola.velx;
                bola.x = bola.x + 3 * bola.velx;

                if (som) {
                    somBola.play();
                }
            }
        }

        function existeColisao(obj1, obj2) {

            var colisaoHorz = obj1.x + obj1.larg > obj2.x && obj1.x < obj2.x + obj2.larg;
            var colisaoVert = obj1.y + obj1.alt > obj2.y && obj1.y < obj2.y + obj2.alt;

            return colisaoHorz && colisaoVert;
        }

        function atualizaPontos() {

            if (bola.x < 0) {
                // ponto para o jogador 2
                raquete2.pontos = raquete2.pontos + 1;
                bolaAoCentro();
            }

            if (bola.x + bola.larg > canvas.width) {
                // ponto para o jogador 1
                raquete1.pontos = raquete1.pontos + 1;
                bolaAoCentro();

            }

        }

        function bolaAoCentro() {

            clearInterval(timer); // cancelar a loop do jogo

            var ang = anguloAoAcaso();
            bola.velx = velBolaX(ang);
            bola.vely = velBolaY(ang);

            bola.x = canvas.width / 2;
            bola.y = canvas.height / 2

            // reposicionar raquetes
            raquete1.y = (ALT_CANVAS - ALT_RAQ)/2;
            raquete2.y = (ALT_CANVAS - ALT_RAQ)/2;

            em_contagem = true;
            timer = setInterval( contagem_regressiva, 500);

        }


        function contagem_regressiva() {

            desenha_contagem();

            contador--;

            if ( contador == -1 ) {
                em_contagem = false;
                contador = 3;
                clearInterval(timer);
                timer = setInterval(jogo, 20);
            }
        }

        function desenha() {

            // Limpar o canvas (tela do jogo)
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            placar = "" + raquete1.pontos + "      ";
            ctx.fillStyle = "red";
            ctx.font = "64px Tourney";
            ctx.textAlign = "center";
            ctx.fillText(placar, 260, 60);

            placar = "" + raquete2.pontos;
            ctx.fillStyle = "blue";
            ctx.font = "64px Tourney";
            ctx.textAlign = "center";
            ctx.fillText(placar, 420, 60);

            // Desenhar a raquete 1
            ctx.beginPath();
            ctx.fillStyle = "red";
            ctx.rect(raquete1.x, raquete1.y, raquete1.larg, raquete1.alt);
            ctx.fill();

            // Desenhar a raquete 2  
            ctx.beginPath();
            ctx.fillStyle = "blue";
            ctx.rect(raquete2.x, raquete2.y, raquete2.larg, raquete2.alt);
            ctx.fill();

            // Desenhar a bola
            ctx.beginPath();
            ctx.fillStyle = "white";
            ctx.rect(bola.x, bola.y, bola.larg, bola.alt);
            ctx.fill();

        }


        function desenha_contagem() {

            // Limpar o canvas (tela do jogo)
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            //ctx.globalAlpha=0.50;\
            ctx.fillStyle = "white";
            ctx.font = "126px Tourney";
            ctx.textAlign = "center";
            ctx.fillText("" + contador, 330, 280);


        }


        function teclaPressionada(e) {

            switch (e.code) {

                case 'ArrowUp':
                    r2tecla.cima = true;
                    break;

                case 'KeyW':
                    r1tecla.cima = true;
                    break;

                case 'ArrowDown':
                    r2tecla.baixo = true;
                    break;

                case 'KeyS':
                    r1tecla.baixo = true;
                    break;
            }
        }

        function teclaLiberada(e) {

            switch (e.code) {

                case 'ArrowUp':
                    r2tecla.cima = false;
                    break;

                case 'KeyW':
                    r1tecla.cima = false;
                    break;

                case 'ArrowDown':
                    r2tecla.baixo = false;
                    break;

                case 'KeyS':
                    r1tecla.baixo = false;
                    break;

            }
        }

        function numAleatorioEntre(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min)
        }

        function anguloAoAcaso() {

            // Gera angulo ao acaso  entre 30 e 55 graus.
            var aux = Math.floor(Math.random() * 40 + 15);

            // Retorna angulo convertido em radianos
            return aux * Math.PI / 180;
        }

        function velBolaX(ang) {

            var vx = VEL_BOLA * Math.cos(ang);

            if (Math.random() > 0.5) {
                vx = -vx;
            }

            return vx;
        }

        function velBolaY(ang) {

            var vy = VEL_BOLA * Math.sin(ang);

            if (Math.random() > 0.5) {
                vy = -vy;
            }

            return vy;
        }

    </script>
</body>

</html>